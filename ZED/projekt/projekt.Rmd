---
title: "Projekt"
author: "Rafał Morawski"
date: "26 10 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```

## R Markdown


```{r Load_packages, warning=FALSE}
library(dplyr)
library(tidyr)
library(knitr)
library(DescTools)
library(readxl)
library(caret)
library(plotly)
```

```{r Load_data_as_df}

orig_data_csv <- read_excel("wuhan_blood_sample_data_Jan_Feb_2020.xlsx")

orig_data_df <- dplyr::as_tibble(orig_data_csv) %>% rename('Tumor necrosis factor-alpha'='Tumor necrosis factor\u03B1', 'Interleukin 1Beta'='Interleukin 1\u03B2',  'gamma-glutamyl transpeptidase'='\u03B3-glutamyl transpeptidase')


```

Ponieważ czesc wierszy, przynależy do konkretnego pacjenta, ale nie posiadaja one id, nalezy te id dopisac:


```{r Restore_id}

new_data_df <- orig_data_df %>% fill(PATIENT_ID) %>% filter(!is.na(RE_DATE))
group_by_id <- new_data_df %>% group_by(PATIENT_ID)

```

%% Analiza danych


```{r analysis_age}

age_vector <- group_by_id %>% distinct(age) %>% ungroup()

hist_age <- ggplot(data=age_vector, aes(x=age)) + 
            geom_histogram(binwidth=1, stat = 'bin', fill='steelblue', color='black') + 
            labs(x='Age', y='Count', title='Histogram of age') + 
            scale_x_continuous(n.breaks = 20) +
            scale_y_continuous(n.breaks = 10) + 
            theme_classic()
      

ggplotly(hist_age)
```





```{r analysis_age2}
hist_age_grouped <- ggplot(data=age_vector, aes(x=age)) + 
            geom_histogram(breaks=c(min(age_vector$age), 40, 65, max(age_vector$age)), stat = 'bin', fill='steelblue', color='black') + 
            labs(x='Age', y='Count', title='Histogram of age (grouped as Young, Middle Aged and Old)', position='dodge2') + 
            scale_y_continuous(n.breaks = 10) +
            scale_x_continuous(breaks=c(min(age_vector$age), 40, 65, max(age_vector$age))) + 
            theme_classic() + 
            annotate(geom='text', x=(40+min(age_vector$age))/2, y=10, label='Young') + 
            annotate(geom='text', x=(65+40)/2, y=10, label='Mid') + 
            annotate(geom='text', x=(max(age_vector$age)+65)/2, y=10, label='Old')
      
ggplotly(hist_age_grouped)

age_data <- ggplot_build(hist_age_grouped)$data
young = age_data[[1]]$y[1]
mid = age_data[[1]]$y[2]
old = age_data[[1]]$y[3]
print(paste("Number of Young to all: ", young*100/(young+mid+old), '%'))
print(paste("Number of Mid to all: ", mid*100/(young+mid+old), '%'))
print(paste("Number of Old to all: ", old*100/(young+mid+old), '%'))
```


```{r analysis_gender}
gender_vector <- group_by_id %>% distinct(gender) %>% ungroup()

hist_gender <- ggplot(data=gender_vector, aes(x=gender)) + 
            geom_histogram(binwidth=1, stat = 'bin', fill='steelblue', color='black') + 
            labs(x='Outcome', y='Count', title='Histogram of outcome') + 
            scale_x_continuous(breaks = c(1, 2), label=c('Male', 'Female')) + 
            theme_classic()
      
ggplotly(hist_gender)


gender_data <- ggplot_build(hist_gender)$data
males = gender_data[[1]]$y[1]
females = gender_data[[1]]$y[2]
print(paste("Number of males to all: ", males*100/(males+females), '%'))
print(paste("Number of females to all: ", females*100/(males+females), '%'))


```



```{r analysis_count}
outcome_vector <- group_by_id %>% distinct(outcome) %>% ungroup()

hist_outcome <- ggplot(data=outcome_vector, aes(x=outcome)) + 
            geom_histogram(binwidth=1, stat = 'bin', fill='steelblue', color='black') + 
            labs(x='Outcome', y='Count', title='Histogram of outcome') + 
            scale_x_continuous(breaks = c(0, 1)) + 
            theme_classic()

ggplotly(hist_outcome)


outcome_data <- ggplot_build(hist_outcome)$data
v0 = outcome_data[[1]]$y[1]
v1 = outcome_data[[1]]$y[2]
print(paste("Number of 0 to all: ", v0*100/(v0+v1), '%'))
print(paste("Number of 1 to all: ", v1*100/(v0+v1), '%'))



```













```{r summarise_fill_empty_values, warning=FALSE}

before_fill <- new_data_df[, c(1, 8:ncol(new_data_df))]

after_fill  <- before_fill %>% group_by(PATIENT_ID) %>% fill(names(.), .direction = 'downup') %>% ungroup()

kable(summary(before_fill[, 8:ncol(before_fill)]))
kable(summary(after_fill[, 2:ncol(after_fill)]))

```



Stosunek liczby wystapien zawierajcej min(NaN) do cakowitej liczby wierszy przed wypelnieniem `r ( before_fill[2:ncol(before_fill)] %>% summarise_all(~sum(is.na(.x))) %>% min() )/nrow(before_fill)*100 `%

Stosunek liczby wystapien zawierajcej max(NaN) do cakowitej liczby wierszy przed wypelnieniem `r ( before_fill[2:ncol(before_fill)] %>% summarise_all(~sum(is.na(.x))) %>% max() )/nrow(before_fill)*100 `%



Stosunek liczby wystapien zawierajcej NaN do cakowitej liczby wierszy po wypelnieniu `r ( after_fill[2:ncol(after_fill)] %>% summarise_all(~sum(is.na(.x))) %>% min() )/nrow(after_fill)*100 `%


Stosunek liczby wystapien zawierajcej NaN do cakowitej liczby wierszy po wypelnieniu `r ( after_fill[2:ncol(after_fill)] %>% summarise_all(~sum(is.na(.x))) %>% max() )/nrow(after_fill)*100 `%









```{r drop_date, warning=FALSE}

data_process_mean <- after_fill %>% 
                     group_by(PATIENT_ID) %>%
                     summarise(across(everything(), 
                                      ~median(.x, na.rm = TRUE), 
                                      .names = "{.col}"))

kable(summary(data_process_mean))
```











```{r plot_many}
n <- names(data_process_mean %>% select(!PATIENT_ID))
nn <- abbreviate(n)
buttons <- list()
buttons_x <- list()
id = 1

for (name in n ){
  ly <- list(method = "restyle", 
            label = paste(nn[[name]], '(', id,  ') as y', sep=''),
            args = list("y", list(data_process_mean[[name]])))
  lx <- list(method = "restyle", 
             label = paste(nn[[name]], '(', id,  ') as x', sep=''),
             args = list("x", list(data_process_mean[[name]])))
  
  buttons <- c(buttons, list(ly))
  buttons_x <- c(buttons_x, list(lx))
  id <- id + 1
}

lx <- list(method = "restyle", 
           label = "None",
           args = list("x", seq(nrow(data_process_mean))))

buttons_x <- c(list(lx), buttons_x)
```


```{r plot_many2}
fig <- plot_ly(data_process_mean, 
               x = ~seq(nrow(data_process_mean)), 
               y = ~data_process_mean[[name[1]]], alpha = 0.3)
fig <- fig %>% add_markers(marker = list(line = list(color = "black", width = 0.5)))

fig <- fig %>% layout(
  title = "Plot of one of or the relationship between the columns.",
  xaxis = list(domain = c(0.1, 1), title = 'x'),
  yaxis = list(title = "y"),
  updatemenus = list(
    list(y = 0.8,
         label='y',
         buttons = buttons
         ),
    list(y = 0.6,
         label='x',
         buttons = buttons_x
         )
    )
  )

fig
```


```{r plot_many}
```






```{r correlation}

correl <- cor(data_process_mean[-1], use='complete.obs')
corr_value <- 0.8

correl_table <- as_tibble(x) %>% mutate(from=names(x))
kable(correl_table)



```

```{r correlation2}
correl_table_filtered <- correl_table %>% 
                         pivot_longer(!from, names_to = "to", values_to = "count") %>% 
                         filter(count >= corr_value, from != to)

kable(correl_table_filtered)
```


```{r correlation3}
correl_table_n_corr <- correl_table_filtered %>% 
                       group_by(from) %>% 
                       summarise(n=n()) 
kable(correl_table_n_corr)
```




```{r correlation3}
correl_table_n_corr_filtered <- correl_table_n_corr %>% filter(n >= 1)
kable(correl_table_n_corr_filtered)
```


```{r columns_to_remove}
correl_table_group_filter <- correl_table_filtered %>% 
                             group_by(from) %>% 
                             filter(from %in% correl_table_n_corr_filtered$from) %>%
                             ungroup() %>%
                             arrange(count) %>%
                             distinct(count, .keep_all = T)
                            

cc <- correl_table_group_filter


kable(cc)

columns_to_remove <- unique(list(correl_table_group_filter$to)[[1]])

kable(columns_to_remove)
```





```{r fill_m1}
join_data <- new_data_df[, c(1, 3, 4, 7)] %>% # select id, age, gender, outcome
             group_by(PATIENT_ID) %>% 
             unique() %>%
             ungroup()
data_replace_na <- data_process_mean %>% 
                   select(-all_of(columns_to_remove)) %>%
                   select(-"2019-nCoV nucleic acid detection") %>%
                   left_join(y=join_data, by='PATIENT_ID')
data_replace_na[is.na(data_replace_na)] <- -1
```








```{r clear_data, warning=FALSE}

data_clear <- ungroup(data_replace_na)
data_clear$outcome = as.factor(data_clear$outcome)
data_clear$gender = as.factor(data_clear$gender)

```


```{r  feature_selection}
control <- rfeControl(functions=rfFuncs,  method="repeatedcv", number=5, repeats=3)

results <- rfe(data_clear[, c(2:55)], data_clear$outcome, sizes=c(1:50), rfeControl=control)

print(results)

predictors(results)

plot(results, type=c("g", "o"))
```

```{r select_features}

data_clear_selected_features <- data_clear %>% select(predictors(results)[1:10], outcome)

```



```{r create_datasets}
data_to_fit <- data_clear_selected_features

set.seed(5555)


partition_set <- caret::createDataPartition(data_to_fit$outcome, p = .7, list = FALSE)
training <- data_to_fit[ partition_set,]
testing  <- data_to_fit[-partition_set,]
```



```{r create_ctrl}

fitControl <- trainControl(method = "repeatedcv",
                           number = 10,
                           repeats = 5)
```


```{r train}
set.seed(2323)
random_forest <- train(outcome ~ .,
                 data = training, 
                 method = "rf", 
                 trControl = fitControl)
random_forest
```


```{r test}
rfClasses <- predict(random_forest, newdata = testing)
confusionMatrix(data = rfClasses, testing$outcome)

prob <- as_tibble(predict(random_forest, newdata = testing, type = "prob")) %>% mutate(outcome=testing$outcome) %>% rename(live="0", die="1")
prob %>% arrange(live)
```

